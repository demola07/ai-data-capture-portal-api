name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AWS_REGION: us-east-1

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      short-sha: ${{ steps.vars.outputs.short-sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: echo "short-sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=main-
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.optimized
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: https://api.ymrcounselling.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get EC2 instance IPs
        id: ec2-ips
        run: |
          INSTANCE_IPS=$(aws ec2 describe-instances \
            --filters "Name=tag:Environment,Values=production" \
                      "Name=tag:Application,Values=ai-data-capture-api" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[*].Instances[*].PrivateIpAddress' \
            --output text)
          echo "instance-ips=${INSTANCE_IPS}" >> $GITHUB_OUTPUT
          echo "Found instances: ${INSTANCE_IPS}"

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ steps.ec2-ips.outputs.instance-ips }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to EC2 instances
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INSTANCE_IPS: ${{ steps.ec2-ips.outputs.instance-ips }}
        run: |
          # Get the main-<sha> tag (first tag)
          NEW_IMAGE=$(echo "$IMAGE_TAG" | head -n 1)
          echo "Deploying image: ${NEW_IMAGE}"
          
          # Deploy to each instance
          for IP in $INSTANCE_IPS; do
            echo "Deploying to instance: $IP"
            
            # Copy deployment script
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
              scripts/deploy.sh ubuntu@${IP}:/tmp/deploy.sh
            
            # Execute deployment
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${IP} << EOF
              set -e
              chmod +x /tmp/deploy.sh
              
              # Export environment variables for the script
              export NEW_IMAGE="${NEW_IMAGE}"
              export GITHUB_TOKEN="${GITHUB_TOKEN}"
              export REGISTRY="${{ env.REGISTRY }}"
              
              # Run deployment script
              sudo -E /tmp/deploy.sh
              
              # Cleanup
              rm /tmp/deploy.sh
          EOF
            
            echo "âœ… Deployment completed on $IP"
          done

      - name: Health check
        env:
          INSTANCE_IPS: ${{ steps.ec2-ips.outputs.instance-ips }}
        run: |
          echo "Running health checks..."
          
          for IP in $INSTANCE_IPS; do
            echo "Checking health on $IP..."
            
            # Wait for service to be ready
            for i in {1..30}; do
              if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ubuntu@${IP} \
                "curl -f http://localhost:8000/health || curl -f http://localhost:8000/" > /dev/null 2>&1; then
                echo "âœ… Health check passed on $IP"
                break
              fi
              
              if [ $i -eq 30 ]; then
                echo "âŒ Health check failed on $IP after 30 attempts"
                exit 1
              fi
              
              echo "Waiting for service... (attempt $i/30)"
              sleep 2
            done
          done

      - name: Create deployment summary
        if: always()
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image-tag }}
          SHORT_SHA: ${{ needs.build-and-push.outputs.short-sha }}
        run: |
          NEW_IMAGE=$(echo "$IMAGE_TAG" | head -n 1)
          
          echo "### ðŸš€ EC2 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${NEW_IMAGE}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Short SHA**: \`${SHORT_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
